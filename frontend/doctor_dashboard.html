<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HMS â€” Doctor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
<style>
  .user-avatar { background: rgba(0,180,216,0.2); color: var(--teal); }
  .profile-card {
    background: linear-gradient(135deg, var(--navy2), #0d2a4a);
    border: 1px solid rgba(0,180,216,0.2);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 28px;
    display: flex;
    align-items: center;
    gap: 24px;
  }
  .profile-avatar {
    width: 72px; height: 72px;
    background: linear-gradient(135deg, var(--teal), var(--teal2));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    flex-shrink: 0;
  }
  .profile-info h2 { font-family: 'Playfair Display', serif; font-size: 1.5rem; }
  .profile-info p { color: var(--gray); font-size: 0.875rem; margin-top: 4px; }
  .profile-meta { display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
  .meta-item { display: flex; align-items: center; gap: 6px; font-size: 0.82rem; color: var(--gray); }
  .meta-item span:first-child { font-size: 14px; }
  .meta-item strong { color: var(--white); }
  .available-badge {
    margin-left: auto;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 600;
  }
  .available-yes { background: rgba(46,204,113,0.15); color: #2ecc71; border: 1px solid rgba(46,204,113,0.3); }
  .available-no { background: rgba(230,57,70,0.15); color: #ff6b6b; border: 1px solid rgba(230,57,70,0.3); }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-brand">
    <div class="icon">ğŸ¥</div>
    <h2>Hospital Management</h2>
    <p>Doctor Portal</p>
  </div>
  <div class="sidebar-user">
    <div class="user-avatar" id="sidebarAvatar">DR</div>
    <div class="user-info">
      <h4 id="sidebarName">Loading...</h4>
      <p id="sidebarRole">Doctor</p>
    </div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Navigation</div>
    <button class="nav-item active" onclick="showSection('overview')"><span class="icon">ğŸ“Š</span> Overview</button>
    <button class="nav-item" onclick="showSection('appointments')"><span class="icon">ğŸ“…</span> Appointments</button>
    <button class="nav-item" onclick="showSection('prescriptions')"><span class="icon">ğŸ’Š</span> Prescriptions</button>
    <button class="nav-item" onclick="showSection('profile')"><span class="icon">ğŸ‘¤</span> My Profile</button>
  </nav>
  <div class="sidebar-footer">
    <button class="btn-logout" onclick="logout()">ğŸšª Sign Out</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <h1 id="pageTitle">Overview</h1>
    <span class="date" id="currentDate"></span>
  </div>
  <div class="content">

    <!-- OVERVIEW -->
    <div id="section-overview">
      <div class="profile-card" id="profileCard">
        <div class="profile-avatar">ğŸ‘¨â€âš•ï¸</div>
        <div class="profile-info">
          <h2 id="doctorName">Loading...</h2>
          <p id="doctorSpec">Specialization</p>
          <div class="profile-meta">
            <div class="meta-item"><span>ğŸªª</span> License: <strong id="licenseNo">â€”</strong></div>
            <div class="meta-item"><span>â±</span> Experience: <strong id="expYears">â€”</strong> years</div>
            <div class="meta-item"><span>ğŸ’°</span> Fee: <strong id="consultFee">â€”</strong></div>
          </div>
        </div>
        <span class="available-badge available-yes" id="availBadge">Available</span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-value" id="totalAppts">â€”</div>
          <div class="stat-label">Total Appointments</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â³</div>
          <div class="stat-value" id="pendingAppts">â€”</div>
          <div class="stat-label">Pending</div>
          <div class="stat-sub">Awaiting confirmation</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-value" id="confirmedAppts">â€”</div>
          <div class="stat-label">Confirmed</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ</div>
          <div class="stat-value" id="completedAppts">â€”</div>
          <div class="stat-label">Completed</div>
        </div>
      </div>

      <div class="two-col">
        <div class="section-card">
          <div class="section-header">
            <div><h3>Recent Appointments</h3><p>Your latest scheduled appointments</p></div>
          </div>
          <div id="recentApptsBody">
            <div class="loading-state"><div class="spinner"></div><span>Loading...</span></div>
          </div>
        </div>
        <div class="section-card">
          <div class="section-header">
            <div><h3>Recent Prescriptions</h3><p>Prescriptions you have written</p></div>
          </div>
          <div id="recentPresBody">
            <div class="loading-state"><div class="spinner"></div><span>Loading...</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- APPOINTMENTS -->
    <div id="section-appointments" style="display:none">
      <div class="section-card">
        <div class="section-header">
          <div><h3>All Appointments</h3><p>Manage your patient appointments</p></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Patient</th><th>Date</th><th>Time</th><th>Reason</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody id="allApptsBody">
              <tr><td colspan="6"><div class="loading-state"><div class="spinner"></div><span>Loading...</span></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PRESCRIPTIONS -->
    <div id="section-prescriptions" style="display:none">
      <div class="section-card">
        <div class="section-header">
          <div><h3>Prescriptions</h3><p>Prescriptions you have written</p></div>
          <button class="btn btn-primary" onclick="openPresModal()">+ New Prescription</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Appointment</th><th>Diagnosis</th><th>Medications</th><th>Follow Up</th><th>Date</th></tr>
            </thead>
            <tbody id="allPresBody">
              <tr><td colspan="5"><div class="loading-state"><div class="spinner"></div><span>Loading...</span></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="section-profile" style="display:none">
      <div class="section-card">
        <div class="section-header"><div><h3>My Profile</h3><p>Update your doctor profile</p></div></div>
        <div style="padding: 24px;">
          <div class="form-group">
            <label>Specialization</label>
            <select id="editSpec">
              <option value="general">General Physician</option>
              <option value="cardiology">Cardiology</option>
              <option value="neurology">Neurology</option>
              <option value="orthopedics">Orthopedics</option>
              <option value="pediatrics">Pediatrics</option>
              <option value="dermatology">Dermatology</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>License Number</label>
            <input type="text" id="editLicense" placeholder="License number">
          </div>
          <div class="form-group">
            <label>Experience (Years)</label>
            <input type="number" id="editExp" placeholder="Years of experience">
          </div>
          <div class="form-group">
            <label>Consultation Fee (â‚¹)</label>
            <input type="number" id="editFee" placeholder="Consultation fee">
          </div>
          <div class="form-group">
            <label>Availability</label>
            <select id="editAvail">
              <option value="true">Available</option>
              <option value="false">Not Available</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PRESCRIPTION MODAL -->
<div class="modal-overlay" id="presModal">
  <div class="modal">
    <h3>ğŸ’Š New Prescription</h3>
    <div class="form-group">
      <label>Appointment ID</label>
      <input type="number" id="presApptId" placeholder="Enter appointment ID">
    </div>
    <div class="form-group">
      <label>Diagnosis</label>
      <textarea id="presDiagnosis" rows="2" placeholder="Enter diagnosis"></textarea>
    </div>
    <div class="form-group">
      <label>Medication (Name)</label>
      <input type="text" id="medName" placeholder="e.g. Paracetamol">
    </div>
    <div class="form-group">
      <label>Dosage</label>
      <input type="text" id="medDosage" placeholder="e.g. 500mg">
    </div>
    <div class="form-group">
      <label>Frequency</label>
      <input type="text" id="medFreq" placeholder="e.g. Twice a day">
    </div>
    <div class="form-group">
      <label>Follow-up Date</label>
      <input type="date" id="followUp">
    </div>
    <div class="form-group">
      <label>Instructions</label>
      <textarea id="presInstructions" rows="2" placeholder="Additional instructions"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closePresModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createPrescription()">Create</button>
    </div>
  </div>
</div>

<!-- STATUS MODAL -->
<div class="modal-overlay" id="statusModal">
  <div class="modal">
    <h3>Update Appointment Status</h3>
    <input type="hidden" id="statusApptId">
    <div class="form-group">
      <label>New Status</label>
      <select id="newStatus">
        <option value="confirmed">Confirmed</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeStatusModal()">Cancel</button>
      <button class="btn btn-primary" onclick="updateStatus()">Update</button>
    </div>
  </div>
</div>

<script>
const API = 'https://hospital-management-system-y46v.onrender.com';
let token = localStorage.getItem('access_token');
let user = JSON.parse(localStorage.getItem('user') || '{}');
let allAppointments = [];

if (!token || user.role !== 'doctor') {
  window.location.href = 'login.html';
}

// Init
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
document.getElementById('sidebarName').textContent = `${user.first_name} ${user.last_name}`;
document.getElementById('sidebarAvatar').textContent = `${user.first_name?.[0]}${user.last_name?.[0]}`;

async function api(url, options = {}) {
  const res = await fetch(`${API}${url}`, {
    ...options,
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...(options.headers || {}) }
  });
  if (res.status === 401) { logout(); return null; }
  return res.json();
}

async function loadAll() {
  const [profile, appointments, prescriptions] = await Promise.all([
    api('/api/doctors/me/'),
    api('/api/appointments/'),
    api('/api/prescriptions/')
  ]);

  if (profile) renderProfile(profile);
  if (appointments) renderAppointments(appointments);
  if (prescriptions) renderPrescriptions(prescriptions);
}

function renderProfile(p) {
  document.getElementById('doctorName').textContent = `Dr. ${p.user?.first_name} ${p.user?.last_name}`;
  document.getElementById('doctorSpec').textContent = p.specialization;
  document.getElementById('licenseNo').textContent = p.license_number || 'â€”';
  document.getElementById('expYears').textContent = p.experience_years || 0;
  document.getElementById('consultFee').textContent = p.consultation_fee ? `â‚¹${p.consultation_fee}` : 'â€”';
  const badge = document.getElementById('availBadge');
  badge.textContent = p.is_available ? 'âœ“ Available' : 'âœ— Unavailable';
  badge.className = `available-badge ${p.is_available ? 'available-yes' : 'available-no'}`;
  // Prefill profile form
  document.getElementById('editSpec').value = p.specialization || 'general';
  document.getElementById('editLicense').value = p.license_number || '';
  document.getElementById('editExp').value = p.experience_years || '';
  document.getElementById('editFee').value = p.consultation_fee || '';
  document.getElementById('editAvail').value = p.is_available ? 'true' : 'false';
}

function renderAppointments(data) {
  allAppointments = data.results || data;
  const list = allAppointments;
  // Stats
  document.getElementById('totalAppts').textContent = list.length;
  document.getElementById('pendingAppts').textContent = list.filter(a => a.status === 'pending').length;
  document.getElementById('confirmedAppts').textContent = list.filter(a => a.status === 'confirmed').length;
  document.getElementById('completedAppts').textContent = list.filter(a => a.status === 'completed').length;

  // Recent (5)
  const recent = list.slice(0, 5);
  document.getElementById('recentApptsBody').innerHTML = recent.length ? `
    <div class="table-wrap"><table>
      <thead><tr><th>Patient</th><th>Date</th><th>Status</th></tr></thead>
      <tbody>${recent.map(a => `
        <tr>
          <td>${a.patient_name || 'Patient #' + a.patient}</td>
          <td>${a.appointment_date}</td>
          <td><span class="badge badge-${a.status}">${a.status}</span></td>
        </tr>`).join('')}
      </tbody>
    </table></div>` : `<div class="empty-state"><div class="empty-icon">ğŸ“…</div><h3>No appointments yet</h3></div>`;

  // All appointments table
  document.getElementById('allApptsBody').innerHTML = list.length ? list.map(a => `
    <tr>
      <td>${a.patient_name || 'Patient #' + a.patient}</td>
      <td>${a.appointment_date}</td>
      <td>${a.appointment_time}</td>
      <td>${a.reason || 'â€”'}</td>
      <td><span class="badge badge-${a.status}">${a.status}</span></td>
      <td><button class="btn btn-sm btn-outline" onclick="openStatusModal(${a.id})">Update</button></td>
    </tr>`).join('') : `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ“…</div><h3>No appointments</h3></div></td></tr>`;
}

function renderPrescriptions(data) {
  const list = data.results || data;
  document.getElementById('recentPresBody').innerHTML = list.length ? `
    <div class="table-wrap"><table>
      <thead><tr><th>Appt #</th><th>Diagnosis</th><th>Date</th></tr></thead>
      <tbody>${list.slice(0,5).map(p => `
        <tr>
          <td>#${p.appointment}</td>
          <td>${p.diagnosis?.substring(0,40) || 'â€”'}${p.diagnosis?.length > 40 ? '...' : ''}</td>
          <td>${p.created_at?.split('T')[0] || 'â€”'}</td>
        </tr>`).join('')}
      </tbody>
    </table></div>` : `<div class="empty-state"><div class="empty-icon">ğŸ’Š</div><h3>No prescriptions yet</h3></div>`;

  document.getElementById('allPresBody').innerHTML = list.length ? list.map(p => `
    <tr>
      <td>#${p.appointment}</td>
      <td>${p.diagnosis || 'â€”'}</td>
      <td>${Array.isArray(p.medications) ? p.medications.map(m => m.name).join(', ') : 'â€”'}</td>
      <td>${p.follow_up_date || 'â€”'}</td>
      <td>${p.created_at?.split('T')[0] || 'â€”'}</td>
    </tr>`).join('') : `<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">ğŸ’Š</div><h3>No prescriptions</h3></div></td></tr>`;
}

function showSection(name) {
  ['overview','appointments','prescriptions','profile'].forEach(s => {
    document.getElementById(`section-${s}`).style.display = s === name ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach((el, i) => {
    el.classList.toggle('active', ['overview','appointments','prescriptions','profile'][i] === name);
  });
  document.getElementById('pageTitle').textContent = name.charAt(0).toUpperCase() + name.slice(1);
}

function openStatusModal(id) {
  document.getElementById('statusApptId').value = id;
  document.getElementById('statusModal').classList.add('show');
}
function closeStatusModal() { document.getElementById('statusModal').classList.remove('show'); }

async function updateStatus() {
  const id = document.getElementById('statusApptId').value;
  const status = document.getElementById('newStatus').value;
  const data = await api(`/api/appointments/${id}/update_status/`, { method: 'PATCH', body: JSON.stringify({ status }) });
  if (data) { showToast('Status updated!', 'success'); closeStatusModal(); loadAll(); }
  else showToast('Failed to update status', 'error');
}

function openPresModal() { document.getElementById('presModal').classList.add('show'); }
function closePresModal() { document.getElementById('presModal').classList.remove('show'); }

async function createPrescription() {
  const data = await api('/api/prescriptions/', {
    method: 'POST',
    body: JSON.stringify({
      appointment: parseInt(document.getElementById('presApptId').value),
      diagnosis: document.getElementById('presDiagnosis').value,
      medications: [{ name: document.getElementById('medName').value, dosage: document.getElementById('medDosage').value, frequency: document.getElementById('medFreq').value, duration: '7 days' }],
      instructions: document.getElementById('presInstructions').value,
      follow_up_date: document.getElementById('followUp').value || null
    })
  });
  if (data && data.id) { showToast('Prescription created!', 'success'); closePresModal(); loadAll(); }
  else showToast('Failed to create prescription', 'error');
}

async function updateProfile() {
  const data = await api('/api/doctors/me/', {
    method: 'PUT',
    body: JSON.stringify({
      specialization: document.getElementById('editSpec').value,
      license_number: document.getElementById('editLicense').value,
      experience_years: parseInt(document.getElementById('editExp').value),
      consultation_fee: document.getElementById('editFee').value,
      is_available: document.getElementById('editAvail').value === 'true'
    })
  });
  if (data) { showToast('Profile updated!', 'success'); loadAll(); }
  else showToast('Failed to update profile', 'error');
}

function showToast(msg, type) {
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function logout() {
  localStorage.clear();
  window.location.href = 'login.html';
}

loadAll();
</script>
</body>
</html>
