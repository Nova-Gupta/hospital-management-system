<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HMS ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--navy:#0a1628;--navy2:#112240;--teal:#00b4d8;--teal2:#0096c7;--gold:#e9c46a;--white:#f0f4f8;--gray:#8892a4;--success:#2ecc71;--error:#e63946;--sw:255px}
body{font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--white);min-height:100vh}
.sidebar{width:var(--sw);background:var(--navy2);height:100vh;display:flex;flex-direction:column;position:fixed;left:0;top:0;border-right:1px solid rgba(255,255,255,.06);z-index:200;transition:transform .28s ease;overflow-y:auto}
.sb-top{padding:22px 18px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-ico{width:40px;height:40px;background:linear-gradient(135deg,var(--teal),var(--teal2));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;margin-bottom:10px}
.sb-top h2{font-family:'Playfair Display',serif;font-size:.9rem;line-height:1.3}
.sb-top p{color:var(--gray);font-size:.7rem;margin-top:2px}
.sb-user{padding:12px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px}
.av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.82rem;flex-shrink:0;background:rgba(233,196,106,.2);color:var(--gold)}
.sb-user h4{font-size:.8rem;font-weight:500}
.sb-user p{font-size:.7rem;color:var(--gray)}
.sb-nav{flex:1;padding:12px 8px}
.nav-lbl{font-size:.62rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--gray);padding:8px 12px 5px}
.ni{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:9px;cursor:pointer;color:var(--gray);font-size:.84rem;margin-bottom:2px;border:none;background:none;width:100%;text-align:left;transition:all .18s}
.ni:hover{background:rgba(255,255,255,.05);color:var(--white)}
.ni.on{background:rgba(0,180,216,.12);color:var(--teal);font-weight:500}
.ni em{font-size:14px;width:16px;text-align:center;font-style:normal}
.sb-foot{padding:12px 8px;border-top:1px solid rgba(255,255,255,.06)}
.logout{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:9px;cursor:pointer;color:var(--error);font-size:.84rem;font-weight:500;border:none;background:none;width:100%;text-align:left;transition:all .18s}
.logout:hover{background:rgba(230,57,70,.1)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:199}
.main{margin-left:var(--sw);min-height:100vh;display:flex;flex-direction:column}
.topbar{padding:13px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px;background:rgba(10,22,40,.92);backdrop-filter:blur(10px);position:sticky;top:0;z-index:50}
.hb{display:none;background:none;border:none;color:var(--white);font-size:24px;cursor:pointer;padding:0 6px;line-height:1;flex-shrink:0}
.topbar h1{font-family:'Playfair Display',serif;font-size:1.2rem;flex:1}
.topbar .dt{color:var(--gray);font-size:.78rem;white-space:nowrap}
.content{padding:20px 24px;flex:1}
.sg{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:22px}
.sg2{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:22px}
.sc{background:var(--navy2);border:1px solid rgba(255,255,255,.06);border-radius:13px;padding:16px;transition:transform .18s}
.sc:hover{transform:translateY(-2px)}
.sc .si{font-size:22px;margin-bottom:8px}
.sc .sv{font-size:1.55rem;font-weight:700;line-height:1;margin-bottom:3px}
.sc .sl{color:var(--gray);font-size:.76rem}
.sc .ss{color:var(--teal);font-size:.7rem;margin-top:4px}
.card{background:var(--navy2);border:1px solid rgba(255,255,255,.06);border-radius:13px;margin-bottom:18px;overflow:hidden}
.ch{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.ch h3{font-size:.92rem;font-weight:600}
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:420px}
th{padding:9px 14px;text-align:left;font-size:.69rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--gray);background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.06);white-space:nowrap}
td{padding:11px 14px;font-size:.83rem;border-bottom:1px solid rgba(255,255,255,.04)}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.b{display:inline-block;padding:3px 8px;border-radius:20px;font-size:.68rem;font-weight:600;text-transform:capitalize;white-space:nowrap}
.bp{background:rgba(243,156,18,.15);color:#f39c12}
.bc{background:rgba(0,180,216,.15);color:var(--teal)}
.bco{background:rgba(46,204,113,.15);color:var(--success)}
.bca{background:rgba(230,57,70,.15);color:var(--error)}
.bpd{background:rgba(46,204,113,.15);color:var(--success)}
.bup{background:rgba(243,156,18,.15);color:#f39c12}
.btn{padding:8px 14px;border-radius:8px;font-size:.8rem;font-weight:500;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all .18s;white-space:nowrap}
.btn-p{background:var(--teal);color:#fff}
.btn-p:hover{background:var(--teal2);transform:translateY(-1px)}
.btn-sm{padding:4px 10px;font-size:.74rem}
.btn-o{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--white)}
.btn-o:hover{border-color:var(--teal);color:var(--teal)}
.ld{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:12px;color:var(--gray)}
.spin{width:26px;height:26px;border:3px solid rgba(0,180,216,.2);border-top-color:var(--teal);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.emp{text-align:center;padding:36px 16px;color:var(--gray)}
.emp .ei{font-size:34px;margin-bottom:10px;opacity:.5}
.emp h3{font-size:.88rem;color:var(--white);margin-bottom:4px}
.mb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:300;align-items:center;justify-content:center;padding:16px}
.mb.on{display:flex}
.modal{background:var(--navy2);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px;width:100%;max-width:440px;max-height:92vh;overflow-y:auto;animation:mi .25s ease}
@keyframes mi{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal h3{font-size:1.05rem;margin-bottom:16px}
.fg{margin-bottom:13px}
.fg label{display:block;color:var(--gray);font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.fg input,.fg select{width:100%;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--white);font-size:.86rem;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .18s}
.fg select option{background:var(--navy2)}
.fg input:focus,.fg select:focus{border-color:var(--teal)}
.ma{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap}
.toast{position:fixed;bottom:20px;right:20px;padding:11px 16px;border-radius:9px;font-size:.82rem;font-weight:500;z-index:999;animation:ti .25s ease;max-width:280px}
.ts{background:rgba(46,204,113,.15);border:1px solid rgba(46,204,113,.3);color:#2ecc71}
.te{background:rgba(230,57,70,.15);border:1px solid rgba(230,57,70,.3);color:#ff6b6b}
@keyframes ti{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:1100px){.sg{grid-template-columns:repeat(2,1fr)}.sg2{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .overlay.on{display:block}
  .hb{display:block}
  .main{margin-left:0}
  .topbar{padding:11px 16px}
  .topbar h1{font-size:1rem}
  .topbar .dt{display:none}
  .content{padding:14px 16px}
  .sg{grid-template-columns:1fr 1fr;gap:10px}
  .sg2{grid-template-columns:1fr 1fr;gap:10px}
  .sc{padding:13px}
  .sc .sv{font-size:1.35rem}
  .modal{padding:18px 14px}
  .toast{bottom:14px;right:14px;left:14px;max-width:none}
}
@media(max-width:400px){.sg{grid-template-columns:1fr 1fr}.sg2{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<div class="overlay" id="ov" onclick="toggleSB()"></div>
<div class="sidebar" id="sb">
  <div class="sb-top"><div class="sb-ico">üè•</div><h2>Hospital Management</h2><p>Admin Portal</p></div>
  <div class="sb-user"><div class="av" id="sbAv">AD</div><div><h4 id="sbName">Admin</h4><p>Administrator</p></div></div>
  <nav class="sb-nav">
    <div class="nav-lbl">Navigation</div>
    <button class="ni on" onclick="show('overview')"><em>üìä</em> Overview</button>
    <button class="ni" onclick="show('doctors')"><em>üë®‚Äç‚öïÔ∏è</em> Doctors</button>
    <button class="ni" onclick="show('patients')"><em>üßë‚Äçü§ù‚Äçüßë</em> Patients</button>
    <button class="ni" onclick="show('appointments')"><em>üìÖ</em> Appointments</button>
    <button class="ni" onclick="show('billing')"><em>üí≥</em> Billing</button>
  </nav>
  <div class="sb-foot"><button class="logout" onclick="logout()">üö™ Sign Out</button></div>
</div>

<div class="main">
  <div class="topbar">
    <button class="hb" onclick="toggleSB()">‚ò∞</button>
    <h1 id="pgTitle">Overview</h1>
    <span class="dt" id="dt"></span>
  </div>
  <div class="content">

    <div id="s-overview">
      <div class="sg">
        <div class="sc"><div class="si">üë®‚Äç‚öïÔ∏è</div><div class="sv" id="stD">‚Äî</div><div class="sl">Doctors</div></div>
        <div class="sc"><div class="si">üßë‚Äçü§ù‚Äçüßë</div><div class="sv" id="stP">‚Äî</div><div class="sl">Patients</div></div>
        <div class="sc"><div class="si">üí∞</div><div class="sv" id="stR">‚Äî</div><div class="sl">Revenue</div><div class="ss">Paid invoices</div></div>
      </div>
      <div class="sg2">
        <div class="sc"><div class="si">üìÖ</div><div class="sv" id="stA">‚Äî</div><div class="sl">Total Appointments</div></div>
        <div class="sc"><div class="si">‚è≥</div><div class="sv" id="stPe">‚Äî</div><div class="sl">Pending</div></div>
        <div class="sc"><div class="si">‚úÖ</div><div class="sv" id="stC">‚Äî</div><div class="sl">Completed</div></div>
      </div>
      <div class="card"><div class="ch"><h3>Recent Appointments</h3></div><div id="rAB"><div class="ld"><div class="spin"></div></div></div></div>
    </div>

    <div id="s-doctors" style="display:none">
      <div class="card"><div class="ch"><h3>All Doctors</h3></div>
        <div class="tw"><table><thead><tr><th>Name</th><th>Specialization</th><th>License</th><th>Experience</th><th>Fee</th><th>Available</th></tr></thead>
        <tbody id="dB"><tr><td colspan="6"><div class="ld"><div class="spin"></div></div></td></tr></tbody></table></div>
      </div>
    </div>

    <div id="s-patients" style="display:none">
      <div class="card"><div class="ch"><h3>All Patients</h3></div>
        <div class="tw"><table><thead><tr><th>Name</th><th>Email</th><th>Blood Group</th><th>DOB</th><th>Emergency</th></tr></thead>
        <tbody id="pB"><tr><td colspan="5"><div class="ld"><div class="spin"></div></div></td></tr></tbody></table></div>
      </div>
    </div>

    <div id="s-appointments" style="display:none">
      <div class="card"><div class="ch"><h3>All Appointments</h3></div>
        <div class="tw"><table><thead><tr><th>Patient</th><th>Doctor</th><th>Date</th><th>Time</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="aB"><tr><td colspan="6"><div class="ld"><div class="spin"></div></div></td></tr></tbody></table></div>
      </div>
    </div>

    <div id="s-billing" style="display:none">
      <div class="card"><div class="ch"><h3>Invoices</h3><button class="btn btn-p" onclick="document.getElementById('im').classList.add('on')">+ Create Invoice</button></div>
        <div class="tw"><table><thead><tr><th>Invoice #</th><th>Appt #</th><th>Amount</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="biB"><tr><td colspan="6"><div class="ld"><div class="spin"></div></div></td></tr></tbody></table></div>
      </div>
    </div>

  </div>
</div>

<!-- INVOICE MODAL -->
<div class="mb" id="im">
  <div class="modal">
    <h3>üí≥ Create Invoice</h3>
    <div class="fg"><label>Appointment ID</label><input type="number" id="iAID"></div>
    <div class="fg"><label>Amount (‚Çπ)</label><input type="number" id="iAmt"></div>
    <div class="fg"><label>Tax (‚Çπ)</label><input type="number" id="iTax" value="0"></div>
    <div class="fg"><label>Discount (‚Çπ)</label><input type="number" id="iDis" value="0"></div>
    <div class="ma">
      <button class="btn btn-o" onclick="document.getElementById('im').classList.remove('on')">Cancel</button>
      <button class="btn btn-p" onclick="createInv()">Create</button>
    </div>
  </div>
</div>

<!-- MARK PAID MODAL -->
<div class="mb" id="pm">
  <div class="modal">
    <h3>Mark Invoice as Paid</h3>
    <input type="hidden" id="pInvID">
    <div class="fg"><label>Payment Method</label>
      <select id="pMeth"><option value="cash">Cash</option><option value="card">Card</option><option value="online">Online</option><option value="insurance">Insurance</option></select>
    </div>
    <div class="ma">
      <button class="btn btn-o" onclick="document.getElementById('pm').classList.remove('on')">Cancel</button>
      <button class="btn btn-p" onclick="markPaid()">Confirm Payment</button>
    </div>
  </div>
</div>

<script>
const API='https://hospital-management-system-y46v.onrender.com';
let token=localStorage.getItem('access_token');
let user=JSON.parse(localStorage.getItem('user')||'{}');
if(!token||user.role!=='admin')window.location.href='login.html';
document.getElementById('dt').textContent=new Date().toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
document.getElementById('sbName').textContent=(`${user.first_name||''} ${user.last_name||''}`).trim()||'Admin';
document.getElementById('sbAv').textContent=`${user.first_name?.[0]||'A'}${user.last_name?.[0]||'D'}`;

async function req(url,o={}){
  const r=await fetch(`${API}${url}`,{...o,headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json',...(o.headers||{})}});
  if(r.status===401){logout();return null}
  return r.json();
}
async function load(){
  const [da,ap,do_,pa,bi]=await Promise.all([req('/api/dashboard/'),req('/api/appointments/'),req('/api/doctors/'),req('/api/patients/'),req('/api/billing/')]);
  if(da)renderDash(da);if(ap)renderAppts(ap);if(do_)renderDocs(do_);if(pa)renderPats(pa);if(bi)renderBilling(bi);
}
function renderDash(d){
  document.getElementById('stD').textContent=d.total_doctors||0;
  document.getElementById('stP').textContent=d.total_patients||0;
  document.getElementById('stR').textContent=`‚Çπ${d.total_revenue||0}`;
  document.getElementById('stA').textContent=d.total_appointments||0;
  document.getElementById('stPe').textContent=d.pending_appointments||0;
  document.getElementById('stC').textContent=d.completed_appointments||0;
}
function bc(s){return{pending:'bp',confirmed:'bc',completed:'bco',cancelled:'bca'}[s]||'bp'}
function renderAppts(data){
  const l=data.results||data;
  document.getElementById('rAB').innerHTML=l.slice(0,8).length?`<div class="tw"><table><thead><tr><th>Patient</th><th>Doctor</th><th>Date</th><th>Status</th></tr></thead><tbody>${l.slice(0,8).map(a=>`<tr><td>${a.patient_name||'#'+a.patient}</td><td>${a.doctor_name||'#'+a.doctor}</td><td>${a.appointment_date}</td><td><span class="b ${bc(a.status)}">${a.status}</span></td></tr>`).join('')}</tbody></table></div>`:`<div class="emp"><div class="ei">üìÖ</div><h3>No appointments yet</h3></div>`;
  document.getElementById('aB').innerHTML=l.length?l.map(a=>`<tr><td>${a.patient_name||'#'+a.patient}</td><td>${a.doctor_name||'#'+a.doctor}</td><td>${a.appointment_date}</td><td>${a.appointment_time}</td><td><span class="b ${bc(a.status)}">${a.status}</span></td><td><button class="btn btn-sm btn-o" onclick="updateAppt(${a.id})">Update</button></td></tr>`).join(''):`<tr><td colspan="6"><div class="emp"><div class="ei">üìÖ</div><h3>No appointments</h3></div></td></tr>`;
}
function renderDocs(data){
  const l=data.results||data;
  document.getElementById('dB').innerHTML=l.length?l.map(d=>`<tr><td>Dr. ${d.user?.first_name} ${d.user?.last_name}</td><td>${d.specialization}</td><td>${d.license_number||'‚Äî'}</td><td>${d.experience_years||0} yrs</td><td>‚Çπ${d.consultation_fee||0}</td><td><span class="b ${d.is_available?'bc':'bca'}">${d.is_available?'Yes':'No'}</span></td></tr>`).join(''):`<tr><td colspan="6"><div class="emp"><div class="ei">üë®‚Äç‚öïÔ∏è</div><h3>No doctors</h3></div></td></tr>`;
}
function renderPats(data){
  const l=data.results||data;
  document.getElementById('pB').innerHTML=l.length?l.map(p=>`<tr><td>${p.user?.first_name} ${p.user?.last_name}</td><td>${p.user?.email||'‚Äî'}</td><td>${p.blood_group||'‚Äî'}</td><td>${p.date_of_birth||'‚Äî'}</td><td>${p.emergency_contact||'‚Äî'}</td></tr>`).join(''):`<tr><td colspan="5"><div class="emp"><div class="ei">üßë‚Äçü§ù‚Äçüßë</div><h3>No patients</h3></div></td></tr>`;
}
function renderBilling(data){
  const l=data.results||data;
  document.getElementById('biB').innerHTML=l.length?l.map(b=>`<tr><td>#${b.id}</td><td>#${b.appointment}</td><td>‚Çπ${b.amount}</td><td>‚Çπ${b.total_amount}</td><td><span class="b ${b.payment_status==='paid'?'bpd':'bup'}">${b.payment_status}</span></td><td>${b.payment_status!=='paid'?`<button class="btn btn-sm btn-p" onclick="openPM(${b.id})">Mark Paid</button>`:'‚Äî'}</td></tr>`).join(''):`<tr><td colspan="6"><div class="emp"><div class="ei">üí≥</div><h3>No invoices</h3></div></td></tr>`;
}
async function createInv(){
  const d=await req('/api/billing/',{method:'POST',body:JSON.stringify({appointment:parseInt(document.getElementById('iAID').value),amount:document.getElementById('iAmt').value,tax:document.getElementById('iTax').value||'0',discount:document.getElementById('iDis').value||'0'})});
  if(d&&d.id){toast('Invoice created!','s');document.getElementById('im').classList.remove('on');load()}else toast('Failed','e');
}
function openPM(id){document.getElementById('pInvID').value=id;document.getElementById('pm').classList.add('on')}
async function markPaid(){
  const id=document.getElementById('pInvID').value,m=document.getElementById('pMeth').value;
  const d=await req(`/api/billing/${id}/mark_paid/`,{method:'PATCH',body:JSON.stringify({payment_method:m})});
  if(d){toast('Payment recorded!','s');document.getElementById('pm').classList.remove('on');load()}else toast('Failed','e');
}
async function updateAppt(id){
  const s=prompt('New status: pending / confirmed / completed / cancelled');
  if(!s)return;
  const d=await req(`/api/appointments/${id}/update_status/`,{method:'PATCH',body:JSON.stringify({status:s})});
  if(d){toast('Updated!','s');load()}else toast('Failed','e');
}
function show(n){
  ['overview','doctors','patients','appointments','billing'].forEach(s=>document.getElementById('s-'+s).style.display=s===n?'block':'none');
  document.querySelectorAll('.ni').forEach((e,i)=>e.classList.toggle('on',['overview','doctors','patients','appointments','billing'][i]===n));
  document.getElementById('pgTitle').textContent=n.charAt(0).toUpperCase()+n.slice(1);
  if(window.innerWidth<=768){document.getElementById('sb').classList.remove('open');document.getElementById('ov').classList.remove('on')}
}
function toggleSB(){document.getElementById('sb').classList.toggle('open');document.getElementById('ov').classList.toggle('on')}
function toast(m,t){const el=document.createElement('div');el.className=`toast t${t}`;el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),3000)}
function logout(){localStorage.clear();window.location.href='login.html'}
load();
</script>
</body>
</html>
